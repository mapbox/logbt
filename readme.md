logbt
-----

Short for "Log Backtrace", this is a bash wrapper for displaying a backtrace when a program crashes.

[![Build Status](https://travis-ci.org/mapbox/logbt.svg?branch=master)](https://travis-ci.org/mapbox/logbt)

Without logbt if a program crashes it will show only an unhelpful error:

```sh
$ ./program
Segmentation fault
```

After logbt you will see a beautiful backtrace:

```sh
$ sudo ./bin/logbt ./program
Setting /tmp/logbt-coredumps/core.%p.%E -> /tmp/logbt-coredumps/core.%p.%E
./bin/logbt: line 112: 15425 Segmentation fault      (core dumped) $*
program exited with code:139
Found core at /tmp/logbt-coredumps/core.15425
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `program     '.
Program terminated with signal 11, Segmentation fault.
#0  0x00007f51f7452317 in kill () from /lib/x86_64-linux-gnu/libc.so.6

Thread 5 (Thread 0x7f51f5c18700 (LWP 15429)):
#0  0x00007f51f77e7fd0 in sem_wait () from /lib/x86_64-linux-gnu/libpthread.so.0
#1  0x0000000000fa97d8 in v8::base::Semaphore::Wait() ()
#2  0x0000000000e46f99 in v8::platform::TaskQueue::GetNext() ()
#3  0x0000000000e470ec in v8::platform::WorkerThread::Run() ()
#4  0x0000000000faa790 in v8::base::ThreadEntry(void*) ()
#5  0x00007f51f77e1e9a in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0
#6  0x00007f51f750f36d in clone () from /lib/x86_64-linux-gnu/libc.so.6
#7  0x0000000000000000 in ?? ()

[... snip ...]
```

### Supports

 - Linux and OS X

### Docker considerations

Docker containers must be run with the `privileged` parameter (`docker run -i --privileged ...`) in order for the `logbt --setup` command to work (it needs to write to `/proc/sys/kernel/core_pattern`). Beware that the value of `/proc/sys/kernel/core_pattern` comes from the host and modifying it in a container will change the value for the host.

For using docker+logbt with AWS, the ECS [container definition](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html#container_definition_security) is how you ask for `privileged` runs.

Note: `--privileged` only applies to `docker run` and not `docker build` (refs https://github.com/docker/docker/issues/1916)

### Depends

Requires `gdb` on linux and `lldb` on OS X.

Recommended install of gdb on linux:

```
mkdir mason && curl -sSfL https://github.com/mapbox/mason/archive/v0.2.0.tar.gz | tar --gunzip --extract --strip-components=1 --directory=./mason
./mason/mason install gdb 7.12
sudo ln -s $(./mason/mason prefix gdb 7.12)/bin/gdb /usr/local/bin/gdb
```

Recommended install of lldb on OS X is to get latest XCode.

### Install

To /usr/local/bin:

```sh
curl -sSfL https://github.com/mapbox/logbt/archive/v1.6.0.tar.gz | tar --gunzip --extract --strip-components=1 --exclude="*md" --exclude="test*" --directory=/usr/local
which logbt
/usr/local/bin/logbt
logbt --version
```

Locally (perhaps if your user cannot write to /usr/local):

```sh
curl -sSfL https://github.com/mapbox/logbt/archive/v1.6.0.tar.gz | tar --gunzip --extract --strip-components=2 --exclude="*md" --exclude="test*" --directory=.
./logbt --version
```

### Usage

There are two steps to using `logbt`. First you set it up and second you launch your program with it.

#### Logbt setup

You must setup `logbt` before use:

```bash
sudo logbt --setup
```

This command sets and validates the system core pattern to ensure it is set in a way logbt can understand and track.

This is required on Linux and optional on OS X if the systems default `kern.corefile` setting is intact. This means that `$(sysctl -n kern.corefile) == '/cores/core.%P'`.

Other options:

 - `logbt --test`: tests that logbt is functioning correctly. Should be run after `logbt --setup`
 - `logbt --version`: Prints the `logbt` version
 - `logbt --help`: Prints the `logbt` usage help
